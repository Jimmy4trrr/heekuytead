local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")
local player = Players.LocalPlayer

_G.AutoBuy = true

-- ฟังก์ชันสำหรับคลิก
local function smartClick(obj, frame)
    if obj and obj:IsA("GuiButton") and obj.Visible then
        -- เลื่อนหน้าจอ
        frame.CanvasPosition = Vector2.new(0, obj.AbsolutePosition.Y - frame.AbsolutePosition.Y)
        task.wait(0.2) 

        local x = obj.AbsolutePosition.X + (obj.AbsoluteSize.X / 2)
        local y = obj.AbsolutePosition.Y + (obj.AbsoluteSize.Y / 2) + 58
        
        VirtualInputManager:SendMouseMoveEvent(x, y, game)
        task.wait(0.1)
        VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
        task.wait(0.05)
        VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
        return true
    end
    return false
end

task.spawn(function()
    while _G.AutoBuy do
        -- 1. ตรวจสอบว่า UI หลักยังอยู่ไหม (ถ้าตาย UI จะโหลดใหม่)
        local mainGui = player.PlayerGui:FindFirstChild("Merchant")
        
        if mainGui then
            local container = mainGui:FindFirstChild("Main")
            
            -- 2. เช็คว่า UI เปิดอยู่ไหม ถ้าปิดอยู่ให้สั่งเปิด (สมมติว่ามีปุ่มเปิดร้านชื่อ OpenMerchant)
            -- *หมายเหตุ: ถ้าเกมไม่มีปุ่มเปิด ต้องเดินไปคุยกับ NPC คุณต้องบอกผมนะครับ*
            if container and not container.Visible then
                print("UI ปิดอยู่ กำลังพยายามเปิด...")
                -- ใส่โค้ดเปิด UI ตรงนี้ (ถ้าต้องกดปุ่ม หรือรัน Event)
                container.Visible = true -- ลองบังคับเปิด
                task.wait(1)
            end

            local scroll = mainGui:FindFirstChild("ScrollingFrame", true) -- หา ScrollingFrame แบบเจาะลึก
            
            if scroll and container.Visible then
                for i = 1, 9 do
                    if not _G.AutoBuy then break end
                    local folder = scroll:FindFirstChild(tostring(i))
                    if folder and folder:FindFirstChild("BuyBtn") then
                        smartClick(folder.BuyBtn, scroll)
                        task.wait(0.3)
                    end
                end
            end
        else
            print("รอ UI Merchant โหลด...")
        end
        
        task.wait(2) -- เว้นระยะเช็คทุก 2 วินาที
    end
end)
